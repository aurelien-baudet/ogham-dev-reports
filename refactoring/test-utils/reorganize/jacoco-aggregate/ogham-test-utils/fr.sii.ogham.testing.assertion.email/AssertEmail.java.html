<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>AssertEmail.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">reporting</a> &gt; <a href="../index.html" class="el_bundle">ogham-test-utils</a> &gt; <a href="index.source.html" class="el_package">fr.sii.ogham.testing.assertion.email</a> &gt; <span class="el_source">AssertEmail.java</span></div><h1>AssertEmail.java</h1><pre class="source lang-java linenums">package fr.sii.ogham.testing.assertion.email;

import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Pattern;

import javax.mail.Address;
import javax.mail.BodyPart;
import javax.mail.Message;
import javax.mail.Message.RecipientType;
import javax.mail.MessagingException;
import javax.mail.Multipart;
import javax.mail.Part;

import org.apache.commons.io.IOUtils;
import org.junit.Assert;
import org.junit.ComparisonFailure;

import fr.sii.ogham.testing.assertion.html.AssertHtml;
import fr.sii.ogham.testing.assertion.util.AssertionRegistry;
import fr.sii.ogham.testing.assertion.util.Executable;
import fr.sii.ogham.testing.assertion.util.FailAtEndRegistry;

/**
 * Utility class for checking if the received email content is as expected.
 * 
 * @author Aur√©lien Baudet
 *
 */
@SuppressWarnings(&quot;squid:S1192&quot;)
public final class AssertEmail {
<span class="fc" id="L35">	private static final Pattern HTML_PATTERN = Pattern.compile(&quot;&lt;html&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="fc" id="L36">	private static final Pattern TEXT_OR_HTML_MIMETYPES = Pattern.compile(&quot;^((text/)|(application/x?html)).*&quot;, Pattern.CASE_INSENSITIVE);</span>

	/**
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains several parts (several contents). The
	 * received email should also have the equivalent parts. It will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The received message is a {@link Multipart} email&lt;/li&gt;
	 * &lt;li&gt;The number of parts are equal&lt;/li&gt;
	 * &lt;li&gt;Each received part body equals the expected one (order is important).
	 * See {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;Each received part Mime Type equals the expected one (order is
	 * important). See {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body is done strictly (totally equal).
	 * &lt;/p&gt;
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmail
	 *            the received email
	 * @throws MessagingException
	 *             when accessing the received email fails
	 * @throws IOException
	 *             when reading the content of the email fails
	 */
	public static void assertEquals(ExpectedMultiPartEmail expectedEmail, Message actualEmail) throws MessagingException, IOException {
<span class="fc" id="L66">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="fc" id="L67">		assertEquals(expectedEmail, actualEmail, true, assertions);</span>
<span class="fc" id="L68">		assertions.execute();</span>
<span class="fc" id="L69">	}</span>

	/**
	 * &lt;p&gt;
	 * Shortcut to simplify unit testing with GreenMail. See
	 * {@link #assertEquals(ExpectedMultiPartEmail[], Message[])}.
	 * &lt;/p&gt;
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains several parts (several contents). The
	 * received email should also have the equivalent parts. It will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The received message is a {@link Multipart} email&lt;/li&gt;
	 * &lt;li&gt;The number of parts are equal&lt;/li&gt;
	 * &lt;li&gt;Each received part body equals the expected one (order is important).
	 * See {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;Each received part Mime Type equals the expected one (order is
	 * important). See {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body is done strictly (totally equal).
	 * &lt;/p&gt;
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmails
	 *            the received email
	 * @throws MessagingException
	 *             when accessing the received email fails
	 * @throws IOException
	 *             when reading the content of the email fails
	 */
	public static void assertEquals(ExpectedMultiPartEmail expectedEmail, Message[] actualEmails) throws MessagingException, IOException {
<span class="nc" id="L103">		assertEquals(new ExpectedMultiPartEmail[] { expectedEmail }, actualEmails);</span>
<span class="nc" id="L104">	}</span>

	/**
	 * Assert that each received email content respects the expected one. It
	 * ensures that the number of received emails equals to the expected number.
	 * Then for each email it calls
	 * {@link #assertEquals(ExpectedMultiPartEmail, Message)} .
	 * 
	 * @param expectedEmails
	 *            the list of expected emails
	 * @param actualEmails
	 *            the received emails
	 * @throws MessagingException
	 *             when accessing the received email fails
	 * @throws IOException
	 *             when reading the content of the email fails
	 */
	public static void assertEquals(ExpectedMultiPartEmail[] expectedEmails, Message[] actualEmails) throws MessagingException, IOException {
<span class="fc" id="L122">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="fc" id="L123">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + expectedEmails.length + &quot; email&quot;, expectedEmails.length, actualEmails.length));</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		for (int i = 0; i &lt; expectedEmails.length; i++) {</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">			assertEquals(expectedEmails[i], i &lt; actualEmails.length ? actualEmails[i] : null, true, assertions);</span>
		}
<span class="nc" id="L127">		assertions.execute();</span>
<span class="nc" id="L128">	}</span>

	/**
	 * &lt;p&gt;
	 * Shortcut to simplify unit testing with GreenMail. See
	 * {@link #assertEquals(ExpectedEmail[], Message[])}.
	 * &lt;/p&gt;
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains only one part (only one content). It
	 * will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The body equals the expected one (order is important). See
	 * {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;The Mime Type equals the expected one (order is important). See
	 * {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body is done strictly (totally equal).
	 * &lt;/p&gt;
	 * 
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmails
	 *            the received emails
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertEquals(ExpectedEmail expectedEmail, Message[] actualEmails) throws MessagingException {
<span class="fc" id="L159">		assertEquals(new ExpectedEmail[] { expectedEmail }, actualEmails);</span>
<span class="fc" id="L160">	}</span>

	/**
	 * Assert that each received email content respects the expected one. It
	 * ensures that the number of received emails equals to the expected number.
	 * Then for each email it calls
	 * {@link #assertEquals(ExpectedEmail, Message)} .
	 * 
	 * @param expectedEmail
	 *            the expected email
	 * @param actualEmails
	 *            the received emails
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertEquals(ExpectedEmail[] expectedEmail, Message[] actualEmails) throws MessagingException {
<span class="fc" id="L176">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="fc" id="L177">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + expectedEmail.length + &quot; email&quot;, expectedEmail.length, actualEmails.length));</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">		for (int i = 0; i &lt; expectedEmail.length; i++) {</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">			assertEquals(expectedEmail[i], i &lt; actualEmails.length ? actualEmails[i] : null, true, assertions);</span>
		}
<span class="fc" id="L181">		assertions.execute();</span>
<span class="fc" id="L182">	}</span>

	/**
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains only one part (only one content). It
	 * will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The body equals the expected one (order is important). See
	 * {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;The Mime Type equals the expected one (order is important). See
	 * {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body is done strictly (totally equal).
	 * &lt;/p&gt;
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmail
	 *            the received email
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertEquals(ExpectedEmail expectedEmail, Message actualEmail) throws MessagingException {
<span class="fc" id="L208">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="fc" id="L209">		assertEquals(expectedEmail, actualEmail, true, assertions);</span>
<span class="fc" id="L210">		assertions.execute();</span>
<span class="fc" id="L211">	}</span>

	/**
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains several parts (several contents). The
	 * received email should also have the equivalent parts. It will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The received message is a {@link Multipart} email&lt;/li&gt;
	 * &lt;li&gt;The number of parts are equal&lt;/li&gt;
	 * &lt;li&gt;Each received part body equals the expected one (order is important).
	 * See {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;Each received part Mime Type equals the expected one (order is
	 * important). See {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body ignores the new line characters.
	 * &lt;/p&gt;
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmail
	 *            the received email
	 * @throws MessagingException
	 *             when accessing the received email fails
	 * @throws IOException
	 *             when reading the content of the email fails
	 */
	public static void assertSimilar(ExpectedMultiPartEmail expectedEmail, Message actualEmail) throws MessagingException, IOException {
<span class="fc" id="L241">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="fc" id="L242">		assertEquals(expectedEmail, actualEmail, false, assertions);</span>
<span class="fc" id="L243">		assertions.execute();</span>
<span class="fc" id="L244">	}</span>

	/**
	 * &lt;p&gt;
	 * Shortcut to simplify unit testing with GreenMail. See
	 * {@link #assertSimilar(ExpectedMultiPartEmail[], Message[])}.
	 * &lt;/p&gt;
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains several parts (several contents). The
	 * received email should also have the equivalent parts. It will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The received message is a {@link Multipart} email&lt;/li&gt;
	 * &lt;li&gt;The number of parts are equal&lt;/li&gt;
	 * &lt;li&gt;Each received part body equals the expected one (order is important).
	 * See {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;Each received part Mime Type equals the expected one (order is
	 * important). See {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body ignores the new line characters.
	 * &lt;/p&gt;
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmails
	 *            the received email
	 * @throws MessagingException
	 *             when accessing the received email fails
	 * @throws IOException
	 *             when reading the content of the email fails
	 */
	public static void assertSimilar(ExpectedMultiPartEmail expectedEmail, Message[] actualEmails) throws MessagingException, IOException {
<span class="nc" id="L278">		assertSimilar(new ExpectedMultiPartEmail[] { expectedEmail }, actualEmails);</span>
<span class="nc" id="L279">	}</span>

	/**
	 * Assert that each received email content respects the expected one. It
	 * ensures that the number of received emails equals to the expected number.
	 * Then for each email it calls
	 * {@link #assertSimilar(ExpectedMultiPartEmail, Message)} .
	 * 
	 * @param expectedEmails
	 *            the list of expected emails
	 * @param actualEmails
	 *            the received emails
	 * @throws MessagingException
	 *             when accessing the received email fails
	 * @throws IOException
	 *             when reading the content of the email fails
	 */
	public static void assertSimilar(ExpectedMultiPartEmail[] expectedEmails, Message[] actualEmails) throws MessagingException, IOException {
<span class="nc" id="L297">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="nc" id="L298">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + expectedEmails.length + &quot; email&quot;, expectedEmails.length, actualEmails.length));</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">		for (int i = 0; i &lt; expectedEmails.length; i++) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">			assertEquals(expectedEmails[i], i &lt; actualEmails.length ? actualEmails[i] : null, false, assertions);</span>
		}
<span class="nc" id="L302">		assertions.execute();</span>
<span class="nc" id="L303">	}</span>

	/**
	 * &lt;p&gt;
	 * Shortcut to simplify unit testing with GreenMail. See
	 * {@link #assertSimilar(ExpectedEmail[], Message[])}.
	 * &lt;/p&gt;
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains only one part (only one content). It
	 * will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The body equals the expected one (order is important). See
	 * {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;The Mime Type equals the expected one (order is important). See
	 * {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body ignores the new line characters.
	 * &lt;/p&gt;
	 * 
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmails
	 *            the received emails
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertSimilar(ExpectedEmail expectedEmail, Message[] actualEmails) throws MessagingException {
<span class="nc" id="L334">		assertSimilar(new ExpectedEmail[] { expectedEmail }, actualEmails);</span>
<span class="nc" id="L335">	}</span>

	/**
	 * Assert that each received email content respects the expected one. It
	 * ensures that the number of received emails equals to the expected number.
	 * Then for each email it calls
	 * {@link #assertSimilar(ExpectedEmail, Message)} .
	 * 
	 * @param expectedEmail
	 *            the expected email
	 * @param actualEmails
	 *            the received emails
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertSimilar(ExpectedEmail[] expectedEmail, Message[] actualEmails) throws MessagingException {
<span class="nc" id="L351">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="nc" id="L352">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + expectedEmail.length + &quot; email&quot;, expectedEmail.length, actualEmails.length));</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">		for (int i = 0; i &lt; expectedEmail.length; i++) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">			assertEquals(expectedEmail[i], i &lt; actualEmails.length ? actualEmails[i] : null, false, assertions);</span>
		}
<span class="nc" id="L356">		assertions.execute();</span>
<span class="nc" id="L357">	}</span>

	/**
	 * Assert that the fields of the received email are equal to the expected
	 * values. The expected email contains only one part (only one content). It
	 * will check that:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received headers are respected (see
	 * {@link #assertHeaders(ExpectedEmailHeader, Message)})&lt;/li&gt;
	 * &lt;li&gt;The body equals the expected one (order is important). See
	 * {@link #assertBody(String, String, boolean)}&lt;/li&gt;
	 * &lt;li&gt;The Mime Type equals the expected one (order is important). See
	 * {@link #assertMimetype(ExpectedContent, String)}&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The checking of the body ignores the new line characters.
	 * &lt;/p&gt;
	 * 
	 * @param expectedEmail
	 *            all the fields with their expected values
	 * @param actualEmail
	 *            the received email
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertSimilar(ExpectedEmail expectedEmail, Message actualEmail) throws MessagingException {
<span class="fc" id="L383">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="fc" id="L384">		assertEquals(expectedEmail, actualEmail, false, assertions);</span>
<span class="fc" id="L385">		assertions.execute();</span>
<span class="fc" id="L386">	}</span>

	/**
	 * Checks that the received Mime Type for the message is like the expected
	 * Mime Type. The expected Mime Type is a regular expression.
	 * 
	 * @param expectedContent
	 *            the expected email content that contains the expected Mime
	 *            Type as regular expression
	 * @param actualEmail
	 *            the received email to check
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertMimetype(ExpectedContent expectedContent, Message actualEmail) throws MessagingException {
<span class="nc" id="L401">		assertMimetype(expectedContent, actualEmail.getContentType());</span>
<span class="nc" id="L402">	}</span>

	/**
	 * Checks that the received Mime Type for the message is like the expected
	 * Mime Type. The expected Mime Type is a regular expression.
	 * 
	 * @param expectedContent
	 *            the expected email content that contains the expected Mime
	 *            Type as regular expression
	 * @param contentType
	 *            the received email Mime Type
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertMimetype(ExpectedContent expectedContent, String contentType) throws MessagingException {
<span class="nc" id="L417">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="nc" id="L418">		assertMimetype(expectedContent, contentType, assertions);</span>
<span class="nc" id="L419">		assertions.execute();</span>
<span class="nc" id="L420">	}</span>

	/**
	 * Checks if the received body equals the expected body. It handles HTML
	 * content and pure text content.
	 * &lt;p&gt;
	 * For text, the check can be done either strictly (totally equal) or not
	 * (ignore new lines).
	 * &lt;/p&gt;
	 * &lt;p&gt;
	 * For HTML, the string content is parsed and DOM trees are compared. The
	 * comparison can be done either strictly (DOM trees are totally equals,
	 * attributes are in the same order) or not (attributes can be in any
	 * order).
	 * &lt;/p&gt;
	 * 
	 * @param expectedBody
	 *            the expected content as string
	 * @param actualBody
	 *            the received content as string
	 * @param strict
	 *            true for strict checking (totally equals) or false to ignore
	 *            new line characters
	 */
	public static void assertBody(String expectedBody, String actualBody, boolean strict) {
<span class="nc" id="L445">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="nc" id="L446">		assertBody(&quot;body&quot;, expectedBody, actualBody, strict, assertions);</span>
<span class="nc" id="L447">		assertions.execute();</span>
<span class="nc" id="L448">	}</span>

	/**
	 * Checks if the received headers corresponds to the expected header values.
	 * It checks if:
	 * &lt;ul&gt;
	 * &lt;li&gt;The received subject equals the expected subject&lt;/li&gt;
	 * &lt;li&gt;The email sender address equals the expected sender address&lt;/li&gt;
	 * &lt;li&gt;The total number of recipients equals the total number of expected
	 * recipients&lt;/li&gt;
	 * &lt;li&gt;The number of &quot;to&quot; recipients equals the number of expected &quot;to&quot;
	 * recipients&lt;/li&gt;
	 * &lt;li&gt;The number of &quot;cc&quot; recipients equals the number of expected &quot;cc&quot;
	 * recipients&lt;/li&gt;
	 * &lt;li&gt;The number of &quot;bcc&quot; recipients equals the number of expected &quot;bcc&quot;
	 * recipients&lt;/li&gt;
	 * &lt;li&gt;Each &quot;to&quot; recipient equals the expected &quot;to&quot; recipient value&lt;/li&gt;
	 * &lt;li&gt;Each &quot;cc&quot; recipient equals the expected &quot;cc&quot; recipient value&lt;/li&gt;
	 * &lt;li&gt;Each &quot;bcc&quot; recipient equals the expected &quot;bcc&quot; recipient value&lt;/li&gt;
	 * &lt;/ul&gt;
	 * 
	 * @param expectedEmail
	 *            the expected header values
	 * @param actualEmail
	 *            the received header values
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertHeaders(ExpectedEmailHeader expectedEmail, Message actualEmail) throws MessagingException {
<span class="nc" id="L477">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="nc" id="L478">		assertHeaders(expectedEmail, actualEmail, assertions);</span>
<span class="nc" id="L479">		assertions.execute();</span>
<span class="nc" id="L480">	}</span>

	/**
	 * Checks if the received headers corresponds to the expected header values.
	 * It checks if:
	 * &lt;ul&gt;
	 * &lt;li&gt;The number of recipients of the provided type equals the number of
	 * expected recipients of the provided type&lt;/li&gt;
	 * &lt;li&gt;Each recipient of the provided type equals the expected recipient
	 * value of the provided type&lt;/li&gt;
	 * &lt;/ul&gt;
	 * 
	 * @param expectedRecipients
	 *            the list of recipient string values
	 * @param actualEmail
	 *            the received header values
	 * @param recipientType
	 *            the type of the recipient to compare
	 * @throws MessagingException
	 *             when accessing the received email fails
	 */
	public static void assertRecipients(List&lt;String&gt; expectedRecipients, Message actualEmail, RecipientType recipientType) throws MessagingException {
<span class="nc" id="L502">		AssertionRegistry assertions = new FailAtEndRegistry();</span>
<span class="nc" id="L503">		assertRecipients(expectedRecipients, actualEmail, recipientType, assertions);</span>
<span class="nc" id="L504">		assertions.execute();</span>
<span class="nc" id="L505">	}</span>

	private static void assertEquals(ExpectedEmail expectedEmail, Message actualEmail, boolean strict, AssertionRegistry assertions) throws MessagingException {
<span class="fc" id="L508">		assertHeaders(expectedEmail, actualEmail, assertions);</span>
<span class="fc" id="L509">		assertBody(&quot;body&quot;, expectedEmail.getExpectedContent().getBody(), getBodyOrNull(actualEmail, assertions), strict, assertions);</span>
<span class="fc" id="L510">		assertMimetype(expectedEmail.getExpectedContent(), getBodyMimetypeOrNull(actualEmail, assertions), assertions);</span>
<span class="fc" id="L511">	}</span>

	private static void assertEquals(ExpectedMultiPartEmail expectedEmail, Message actualEmail, boolean strict, AssertionRegistry assertions) throws MessagingException, IOException {
<span class="fc" id="L514">		assertHeaders(expectedEmail, actualEmail, assertions);</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">		Object content = actualEmail==null ? null : actualEmail.getContent();</span>
<span class="fc" id="L516">		assertions.register(() -&gt; Assert.assertTrue(&quot;should be multipart message&quot;, content instanceof Multipart));</span>
<span class="fc" id="L517">		List&lt;Part&gt; bodyParts = getBodyParts(actualEmail);</span>
<span class="fc" id="L518">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + expectedEmail.getExpectedContents().size() + &quot; parts&quot;, expectedEmail.getExpectedContents().size(), bodyParts.size()));</span>
<span class="fc bfc" id="L519" title="All 2 branches covered.">		for (int i = 0; i &lt; expectedEmail.getExpectedContents().size(); i++) {</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">			Part part = i &lt; bodyParts.size() ? bodyParts.get(i) : null;</span>
<span class="pc bpc" id="L521" title="1 of 4 branches missed.">			assertBody(&quot;body[&quot;+i+&quot;]&quot;, expectedEmail.getExpectedContents().get(i).getBody(), part == null || part.getContent() == null ? null : part.getContent().toString(), strict, assertions);</span>
<span class="fc bfc" id="L522" title="All 2 branches covered.">			assertMimetype(expectedEmail.getExpectedContents().get(i), part == null ? null : part.getContentType(), assertions);</span>
		}
<span class="fc" id="L524">	}</span>

	private static void assertMimetype(ExpectedContent expectedContent, String contentType, AssertionRegistry assertions) {
<span class="fc bfc" id="L527" title="All 4 branches covered.">		assertions.register(() -&gt; Assert.assertTrue(&quot;mimetype should match &quot; + expectedContent.getMimetype() + &quot; instead of &quot; + contentType, contentType!=null &amp;&amp; expectedContent.getMimetype().matcher(contentType).matches()));</span>
<span class="fc" id="L528">	}</span>

	private static void assertBody(String name, String expectedBody, String actualBody, boolean strict, AssertionRegistry assertions) {
<span class="fc bfc" id="L531" title="All 2 branches covered.">		if (isHtml(expectedBody)) {</span>
<span class="fc bfc" id="L532" title="All 2 branches covered.">			if (strict) {</span>
<span class="fc" id="L533">				assertions.register(() -&gt; AssertHtml.assertIdentical(expectedBody, actualBody));</span>
			} else {
<span class="fc" id="L535">				assertions.register(() -&gt; AssertHtml.assertSimilar(expectedBody, actualBody));</span>
			}
		} else {
<span class="fc" id="L538">			assertions.register(() -&gt; {</span>
<span class="fc bfc" id="L539" title="All 6 branches covered.">				if (strict ? !expectedBody.equals(actualBody) : !sanitize(expectedBody).equals(sanitize(actualBody))) {</span>
<span class="fc" id="L540">					throw new ComparisonFailure(name + &quot; should be '&quot; + expectedBody + &quot;'&quot;, expectedBody, actualBody);</span>
				}
<span class="fc" id="L542">			});</span>
		}
<span class="fc" id="L544">	}</span>

	private static void assertHeaders(ExpectedEmailHeader expectedEmail, Message actualEmail, AssertionRegistry assertions) throws MessagingException {
<span class="fc bfc" id="L547" title="All 4 branches covered.">		Address[] from = actualEmail==null || actualEmail.getFrom()==null ? null : actualEmail.getFrom();</span>
<span class="fc bfc" id="L548" title="All 2 branches covered.">		assertions.register(() -&gt; Assert.assertEquals(&quot;subject should be '&quot; + expectedEmail.getSubject() + &quot;'&quot;, expectedEmail.getSubject(), actualEmail==null ? null : actualEmail.getSubject()));</span>
<span class="fc bfc" id="L549" title="All 2 branches covered.">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have only one from&quot;, (Integer) 1, from==null ? null : from.length));</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">		assertions.register(() -&gt; Assert.assertEquals(&quot;from should be '&quot; + expectedEmail.getFrom() + &quot;'&quot;, expectedEmail.getFrom(), from==null ? null : from[0].toString()));</span>
<span class="fc" id="L551">		int recipients = expectedEmail.getTo().size() + expectedEmail.getBcc().size() + expectedEmail.getCc().size();</span>
<span class="fc bfc" id="L552" title="All 4 branches covered.">		assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + recipients + &quot; recipients&quot;, (Integer) recipients, actualEmail==null || actualEmail.getAllRecipients()==null ? null : actualEmail.getAllRecipients().length));</span>
<span class="fc" id="L553">		assertRecipients(expectedEmail.getTo(), actualEmail, RecipientType.TO, assertions);</span>
<span class="fc" id="L554">		assertRecipients(expectedEmail.getCc(), actualEmail, RecipientType.CC, assertions);</span>
<span class="fc" id="L555">		assertRecipients(expectedEmail.getBcc(), actualEmail, RecipientType.BCC, assertions);</span>
<span class="fc" id="L556">	}</span>

	private static void assertRecipients(List&lt;String&gt; expectedRecipients, Message actualEmail, RecipientType recipientType, AssertionRegistry assertions) throws MessagingException {
<span class="fc bfc" id="L559" title="All 2 branches covered.">		Address[] actualRecipients = actualEmail==null ? null : actualEmail.getRecipients(recipientType);</span>
<span class="fc bfc" id="L560" title="All 2 branches covered.">		if (expectedRecipients.isEmpty()) {</span>
<span class="pc bpc" id="L561" title="3 of 4 branches missed.">			assertions.register(() -&gt; Assert.assertTrue(&quot;should have no recipients &quot; + recipientType, actualRecipients == null || actualRecipients.length == 0));</span>
		} else {
<span class="fc bfc" id="L563" title="All 2 branches covered.">			assertions.register(() -&gt; Assert.assertEquals(&quot;should have &quot; + expectedRecipients.size() + &quot; &quot; + recipientType, (Integer) expectedRecipients.size(), actualRecipients==null ? null : actualRecipients.length));</span>
<span class="fc bfc" id="L564" title="All 2 branches covered.">			for (int i = 0; i &lt; expectedRecipients.size(); i++) {</span>
<span class="fc" id="L565">				final int idx = i;</span>
<span class="pc bpc" id="L566" title="1 of 4 branches missed.">				assertions.register(() -&gt; Assert.assertEquals(recipientType + &quot;[&quot; + idx + &quot;] should be '&quot; + expectedRecipients.get(idx) + &quot;'&quot;, expectedRecipients.get(idx),</span>
<span class="fc" id="L567">						actualRecipients != null &amp;&amp; idx &lt; actualRecipients.length ? actualRecipients[idx].toString() : null));</span>
			}
		}
<span class="fc" id="L570">	}</span>

	/**
	 * Remove new lines from the string.
	 * 
	 * @param str
	 *            the string to sanitize
	 * @return the sanitized string
	 */
	private static String sanitize(String str) {
<span class="fc" id="L580">		return str.replaceAll(&quot;\r|\n&quot;, &quot;&quot;);</span>
	}

	private static Part getBodyPart(Part actualEmail) throws MessagingException {
<span class="fc" id="L584">		List&lt;Part&gt; bodyParts = getBodyParts(actualEmail);</span>
<span class="fc bfc" id="L585" title="All 2 branches covered.">		if (bodyParts.isEmpty()) {</span>
<span class="fc" id="L586">			throw new IllegalStateException(&quot;Expected at least one body part but none found&quot;);</span>
		}
<span class="fc" id="L588">		return bodyParts.get(0);</span>
	}

	private static List&lt;Part&gt; getBodyParts(Part actualEmail) throws MessagingException {
<span class="fc" id="L592">		List&lt;Part&gt; founds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L593">		getBodyParts(actualEmail, founds);</span>
<span class="fc" id="L594">		return founds;</span>
	}

	private static void getBodyParts(Part actualEmail, List&lt;Part&gt; founds) throws MessagingException {
		try {
<span class="fc bfc" id="L599" title="All 2 branches covered.">			Object content = actualEmail==null ? null : actualEmail.getContent();</span>
<span class="fc bfc" id="L600" title="All 2 branches covered.">			if (content instanceof Multipart) {</span>
<span class="fc" id="L601">				Multipart mp = (Multipart) content;</span>
<span class="fc bfc" id="L602" title="All 2 branches covered.">				for (int i = 0; i &lt; mp.getCount(); i++) {</span>
<span class="fc" id="L603">					addPart(founds, mp, i);</span>
				}
			}
<span class="nc" id="L606">		} catch (IOException e) {</span>
<span class="nc" id="L607">			throw new MessagingException(&quot;Failed to access content of the mail&quot;, e);</span>
<span class="fc" id="L608">		}</span>
<span class="fc" id="L609">	}</span>

	private static void addPart(List&lt;Part&gt; founds, Multipart mp, int i) throws MessagingException {
<span class="fc" id="L612">		BodyPart part = mp.getBodyPart(i);</span>
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">		if (part.getContentType().startsWith(&quot;multipart/&quot;)) {</span>
<span class="nc" id="L614">			getBodyParts(part, founds);</span>
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">		} else if (TEXT_OR_HTML_MIMETYPES.matcher(part.getContentType()).matches()) {</span>
<span class="fc" id="L616">			founds.add(part);</span>
		}
<span class="fc" id="L618">	}</span>

	private static String getBody(Part actualEmail) throws MessagingException {
		try {
<span class="fc" id="L622">			Object content = getBodyPart(actualEmail).getContent();</span>
<span class="fc bfc" id="L623" title="All 2 branches covered.">			if (content instanceof String) {</span>
<span class="fc" id="L624">				return (String) content;</span>
<span class="pc bpc" id="L625" title="1 of 2 branches missed.">			} else if (content instanceof InputStream) {</span>
<span class="nc" id="L626">				return IOUtils.toString((InputStream) content, Charset.defaultCharset());</span>
			} else {
<span class="fc" id="L628">				return content.toString();</span>
			}
<span class="nc" id="L630">		} catch (IOException e) {</span>
<span class="nc" id="L631">			throw new MessagingException(&quot;Failed to access content of the mail&quot;, e);</span>
		}
	}

	private static String getBodyMimetype(Part actualEmail) throws MessagingException {
<span class="fc" id="L636">		return getBodyPart(actualEmail).getContentType();</span>
	}

	private static String getBodyOrNull(Part actualEmail, AssertionRegistry registry) throws MessagingException {
		try {
<span class="fc" id="L641">			return getBody(actualEmail);</span>
<span class="nc" id="L642">		} catch(MessagingException e) {</span>
<span class="nc" id="L643">			registry.register(failure(e));</span>
<span class="nc" id="L644">			return null;</span>
<span class="fc" id="L645">		} catch(IllegalStateException e) {</span>
<span class="fc" id="L646">			registry.register(failure(e));</span>
<span class="fc" id="L647">			return null;</span>
		}
	}
	
	private static &lt;E extends Exception&gt; Executable&lt;E&gt; failure(E exception) {
<span class="fc" id="L652">		return new Executable&lt;E&gt;() {</span>
			@Override
			public void run() throws E {
<span class="fc" id="L655">				throw exception;</span>
			}
		};
	}

	private static String getBodyMimetypeOrNull(Part actualEmail, AssertionRegistry registry) throws MessagingException {
		try {
<span class="fc" id="L662">			return getBodyMimetype(actualEmail);</span>
<span class="nc" id="L663">		} catch(MessagingException e) {</span>
<span class="nc" id="L664">			registry.register(failure(e));</span>
<span class="nc" id="L665">			return null;</span>
<span class="fc" id="L666">		} catch(IllegalStateException e) {</span>
<span class="fc" id="L667">			registry.register(failure(e));</span>
<span class="fc" id="L668">			return null;</span>
		}
	}

	private static boolean isHtml(String expectedBody) {
<span class="fc" id="L673">		return HTML_PATTERN.matcher(expectedBody).find();</span>
	}

	private AssertEmail() {
		super();
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>