(function() {
	var process = function() {
		var tabContainerStarts = $('.tab-container');
		var tabContainerEnds = $('.tab-container-end');
		if(tabContainerStarts.length!=tabContainerEnds.length) {
			throw new Error("The number of tab-container is different from tab-container-end");
		}
		for(var i=0 ; i<tabContainerStarts.length ; i++) {
			generateTabContainer(i, tabContainerStarts[i], tabContainerEnds[i]);
		}
	}
	
	var generateTabContainer = function(/*int*/group, /*Node*/start, /*Node*/end) {
		$(start).append('<div class="tabs-wrapper">');
		var tabWrapper = $(start).find('.tabs-wrapper');
		$(start).append('<div class="tabs-content-wrapper">');
		var tabContentWrapper = $(start).find('.tabs-content-wrapper');
		var tabs = $(start).nextUntil(end, '.tab');
		var height = 0;
		for(var i=0 ; i<tabs.length ; i++) {
			// get parts generated by asciidoctor:
			// - title of a particular tab
			// - content of a particular tab
			var tab = tabs[i];
			var tabTitleNode = $(tab).find('p');
			var tabTitle = tabTitleNode.html();
			var contentNodes = $(tab).nextUntil(tabs[i+1] || end);
			// transform html to:
			// <div class="tab-container">                     | start
			//  *                                              | anything else that don't belong to a tab
			//  <div class="tabs-wrapper">                     | container for styling
			//    <div class="tab">                            | one tab
			//      <input type="radio" />                     | selection of tab
			//      <label class="tab-label">${title}</label>  | title of tab
			//  <div class="tabs-content-wrapper">             | container for styling
			//    <div class="tab-content">                    | content of tab
			//      ${contentNodes}
			$(tabWrapper).append(tab);
			$(tab).prepend('<input type="radio" id="tab-'+group+'-'+i+'" value="'+i+'" name="tab-group-'+group+'" '+(i==0 ? 'checked' : '')+'>');
			tabTitleNode.replaceWith('<label class="tab-label" for="tab-'+group+'-'+i+'">'+tabTitle+'</label>');
			
			$(tabContentWrapper).append('<div class="tab-content'+(i==0 ? ' selected' : '')+'">');
			var tabContentNode = $(tabContentWrapper).find('.tab-content')[i];
			$(tabContentNode).append(contentNodes);
			var contentHeight = computeHeight($(tabContentNode));
			if(contentHeight>height) {
				height = contentHeight;
			}
		}
//		var tabBarHeight = 0;
//		for(var i=0 ; i<tabs.length ; i++) {
//			var tabTitleNode = $(tabs[i]);
//			var tabHeight = computeHeight(tabTitleNode);
//			if (tabHeight > tabBarHeight) {
//				tabBarHeight = tabHeight;
//			}
//		}
		$(tabContentWrapper).css('height', (height/*+tabBarHeight*/+computeContainerHeight(start)+10)+'px');		// add 10px for possible vertical scrollbar that may appear
		$(end).remove();
		$('input[type="radio"]', tabWrapper).change(function() {
			var tabContents = $('.tab-content', tabContentWrapper);
			tabContents.removeClass('selected');
			$(tabContents[$(this).attr('value')]).addClass('selected');
		});
		$(start).addClass('ready');
	}
	
	var computeHeight = function(/*Node[]*/nodes) {
		var totalHeight = 0;
		for(var i=0 ; i<nodes.length ; i++) {
			$(nodes[i]).css('position', 'relative');
			totalHeight += $(nodes[i]).outerHeight(true);
			$(nodes[i]).css('position', '');
		}
		return totalHeight;
	}
	
	var computeContainerHeight = function(/*Node*/ container) {
		var children = $('> *', container);
		for (var i=0 ; i<children.length ; i++) {
			$(children[i]).css('display', 'none');
		}
		var height = $(container).outerHeight();
		for (var i=0 ; i<children.length ; i++) {
			$(children[i]).css('display', '');
		}
		return height;
	}
	
	$(document).ready(process);
})();